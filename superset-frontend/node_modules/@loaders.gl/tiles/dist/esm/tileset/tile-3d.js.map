{"version":3,"sources":["../../../src/tileset/tile-3d.ts"],"names":["Vector3","Matrix4","CullingVolume","load","TILE_REFINEMENT","TILE_CONTENT_STATE","TILESET_TYPE","createBoundingVolume","getTiles3DScreenSpaceError","getI3ScreenSize","get3dTilesOptions","TilesetTraverser","scratchVector","defined","x","undefined","TileHeader","constructor","tileset","header","parentHeader","extendedId","id","url","parent","refine","_getRefine","type","contentUrl","lodMetricType","lodMetricValue","boundingVolume","content","contentState","UNLOADED","gpuMemoryUsageInBytes","children","hasEmptyContent","hasTilesetContent","depth","viewportIds","userData","_priority","_touchedFrame","_visitedFrame","_selectedFrame","_requestedFrame","_screenSpaceError","_cacheNode","_frameNumber","traverser","_shouldRefine","_distanceToCamera","_centerZDepth","_visible","_inRequestVolume","_stackLength","_selectionDepth","_initialTransform","transform","_initializeLodMetric","_initializeTransforms","_initializeBoundingVolumes","_initializeContent","_initializeRenderingState","_lodJudge","_expireDate","_expiredContent","Object","seal","destroy","isDestroyed","selected","isVisible","isVisibleAndInRequestVolume","hasRenderContent","hasChildren","length","contentReady","READY","contentAvailable","Boolean","contentFailed","hasUnloadedContent","contentUnloaded","contentExpired","EXPIRED","FAILED","getScreenSpaceError","frameState","useParentLodMetric","I3S","TILES3D","Error","_getPriority","_traverser","skipLevelOfDetail","options","maySkipTile","ADD","useParentScreenSpaceError","screenSpaceError","rootScreenSpaceError","root","Math","max","loadContent","expired","LOADING","requestToken","_requestScheduler","scheduleRequest","bind","getTileUrl","loader","loadOptions","isTileset","_getLoaderSpecificOptions","contentLoader","_isTileset","_initializeTileHeaders","_onContentLoaded","error","done","unloadContent","updateVisibility","frameNumber","parentVisibilityPlaneMask","_visibilityPlaneMask","MASK_INDETERMINATE","updateTransforms","parentTransform","computedTransform","modelMatrix","_updateTransform","distanceToTile","visibility","MASK_OUTSIDE","insideViewerRequestVolume","cullingVolume","computeVisibilityWithPlaneMask","contentVisibility","sqrt","distanceSquaredTo","camera","position","cameraSpaceZDepth","subVectors","center","direction","dot","viewerRequestVolume","_viewerRequestVolume","updateExpiration","now","Date","lessThan","extras","console","warn","tileHeader","clone","multiplyRight","parentInitialTransform","_contentBoundingVolume","_updateBoundingVolume","_tileset","_tile","level","REPLACE","indexOf","disableSkipLevelOfDetail","didTransformChange","equals","loaderId","i3s","tile","isTileHeader"],"mappings":"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","sourcesContent":["// This file is derived from the Cesium code base under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\nimport {Vector3, Matrix4} from '@math.gl/core';\nimport {CullingVolume} from '@math.gl/culling';\n\nimport {load} from '@loaders.gl/core';\nimport {TILE_REFINEMENT, TILE_CONTENT_STATE, TILESET_TYPE} from '../constants';\n\nimport {FrameState} from './helpers/frame-state';\nimport {createBoundingVolume} from './helpers/bounding-volume';\nimport {getTiles3DScreenSpaceError} from './helpers/tiles-3d-lod';\nimport {getI3ScreenSize} from './helpers/i3s-lod';\nimport {get3dTilesOptions} from './helpers/3d-tiles-options';\nimport TilesetTraverser from './traversers/tileset-traverser';\n\n// Note: circular dependency\nimport type Tileset3D from './tileset-3d';\n\nconst scratchVector = new Vector3();\n\nfunction defined(x) {\n  return x !== undefined && x !== null;\n}\n\n/**\n * @param tileset - Tileset3D instance\n * @param header - tile header - JSON loaded from a dataset\n * @param parentHeader - parent TileHeader instance\n * @param extendedId - optional ID to separate copies of a tile for different viewports.\n *                              const extendedId = `${tile.id}-${frameState.viewport.id}`;\n */\nexport type TileHeaderProps = {\n  tileset: Tileset3D;\n  header: Object;\n  parentHeader: TileHeader;\n  extendedId: string;\n};\n\n/**\n * A Tile3DHeader represents a tile as Tileset3D. When a tile is first created, its content is not loaded;\n * the content is loaded on-demand when needed based on the view.\n * Do not construct this directly, instead access tiles through {@link Tileset3D#tileVisible}.\n */\nexport default class TileHeader {\n  tileset: Tileset3D;\n  header: any;\n  id: string;\n  url: string;\n  parent: TileHeader;\n  refine: number;\n  type: string;\n  contentUrl: string;\n  lodMetricType: string;\n  lodMetricValue: number;\n  boundingVolume: any;\n  content: any;\n  contentState: any;\n  gpuMemoryUsageInBytes: number;\n  children: TileHeader[];\n  depth: number;\n  viewportIds: any[];\n  transform: Matrix4;\n\n  // Container to store application specific data\n  userData: {[key: string]: any};\n  computedTransform: any;\n  hasEmptyContent: boolean;\n  hasTilesetContent: boolean;\n\n  traverser: object;\n\n  // @ts-ignore\n  private _cacheNode: any;\n  private _frameNumber: any;\n  // TODO i3s specific, needs to remove\n  // @ts-ignore\n  private _lodJudge: any;\n  // TODO Cesium 3d tiles specific\n  private _expireDate: any;\n  private _expiredContent: any;\n  // @ts-ignore\n  private _shouldRefine: boolean;\n\n  // Members this are updated every frame for tree traversal and rendering optimizations:\n  // @ts-ignore\n  private _distanceToCamera: number;\n  // @ts-ignore\n  private _centerZDepth: number;\n  private _screenSpaceError: number;\n  private _visibilityPlaneMask: any;\n  private _visible?: boolean;\n  private _inRequestVolume: boolean;\n\n  // @ts-ignore\n  private _stackLength: number;\n  // @ts-ignore\n  private _selectionDepth: number;\n\n  // @ts-ignore\n  private _touchedFrame: number;\n  // @ts-ignore\n  private _visitedFrame: number;\n  private _selectedFrame: number;\n  // @ts-ignore\n  private _requestedFrame: number;\n\n  // @ts-ignore\n  private _priority: number;\n\n  private _contentBoundingVolume: any;\n  private _viewerRequestVolume: any;\n\n  _initialTransform: Matrix4;\n\n  /**\n   * @constructs\n   * Create a TileHeader instance\n   * @param tileset - Tileset3D instance\n   * @param header - tile header - JSON loaded from a dataset\n   * @param parentHeader - parent TileHeader instance\n   * @param extendedId - optional ID to separate copies of a tile for different viewports.\n   *    const extendedId = `${tile.id}-${frameState.viewport.id}`;\n   */\n  // eslint-disable-next-line max-statements\n  constructor(\n    tileset: Tileset3D,\n    header: {[key: string]: any},\n    parentHeader?: TileHeader,\n    extendedId = ''\n  ) {\n    // PUBLIC MEMBERS\n    // original tile data\n    this.header = header;\n\n    // The tileset containing this tile.\n    this.tileset = tileset;\n    this.id = extendedId || header.id;\n    this.url = header.url;\n\n    // This tile's parent or `undefined` if this tile is the root.\n    // @ts-ignore\n    this.parent = parentHeader;\n    this.refine = this._getRefine(header.refine);\n    this.type = header.type;\n    this.contentUrl = header.contentUrl;\n\n    // The error, in meters, introduced if this tile is rendered and its children are not.\n    this.lodMetricType = 'geometricError';\n    this.lodMetricValue = 0;\n\n    // Specifies the type of refine that is used when traversing this tile for rendering.\n    this.boundingVolume = null;\n\n    // The tile's content.  This represents the actual tile's payload,\n    // not the content's metadata in the tileset JSON file.\n    this.content = null;\n    this.contentState = TILE_CONTENT_STATE.UNLOADED;\n    this.gpuMemoryUsageInBytes = 0;\n\n    // The tile's children - an array of Tile3D objects.\n    this.children = [];\n\n    this.hasEmptyContent = false;\n    this.hasTilesetContent = false;\n\n    this.depth = 0;\n    this.viewportIds = [];\n\n    // Container to store application specific data\n    this.userData = {};\n\n    // PRIVATE MEMBERS\n    this._priority = 0;\n    this._touchedFrame = 0;\n    this._visitedFrame = 0;\n    this._selectedFrame = 0;\n    this._requestedFrame = 0;\n    this._screenSpaceError = 0;\n\n    this._cacheNode = null;\n    this._frameNumber = null;\n    this._cacheNode = null;\n\n    this.traverser = new TilesetTraverser({});\n    this._shouldRefine = false;\n    this._distanceToCamera = 0;\n    this._centerZDepth = 0;\n    this._visible = undefined;\n    this._inRequestVolume = false;\n    this._stackLength = 0;\n    this._selectionDepth = 0;\n    this._initialTransform = new Matrix4();\n    this.transform = new Matrix4();\n\n    this._initializeLodMetric(header);\n    this._initializeTransforms(header);\n    this._initializeBoundingVolumes(header);\n    this._initializeContent(header);\n    this._initializeRenderingState(header);\n\n    // TODO i3s specific, needs to remove\n    this._lodJudge = null;\n\n    // TODO Cesium 3d tiles specific\n    this._expireDate = null;\n    this._expiredContent = null;\n\n    Object.seal(this);\n  }\n\n  destroy() {\n    this.header = null;\n  }\n\n  isDestroyed() {\n    return this.header === null;\n  }\n\n  get selected() {\n    return this._selectedFrame === this.tileset._frameNumber;\n  }\n\n  get isVisible() {\n    return this._visible;\n  }\n\n  get isVisibleAndInRequestVolume() {\n    return this._visible && this._inRequestVolume;\n  }\n\n  /** Returns true if tile is not an empty tile and not an external tileset */\n  get hasRenderContent() {\n    return !this.hasEmptyContent && !this.hasTilesetContent;\n  }\n\n  /** Returns true if tile has children */\n  get hasChildren() {\n    return this.children.length > 0 || (this.header.children && this.header.children.length > 0);\n  }\n\n  /**\n   * Determines if the tile's content is ready. This is automatically `true` for\n   * tiles with empty content.\n   */\n  get contentReady() {\n    return this.contentState === TILE_CONTENT_STATE.READY || this.hasEmptyContent;\n  }\n\n  /**\n   * Determines if the tile has available content to render.  `true` if the tile's\n   * content is ready or if it has expired content this renders while new content loads; otherwise,\n   */\n  get contentAvailable() {\n    return Boolea